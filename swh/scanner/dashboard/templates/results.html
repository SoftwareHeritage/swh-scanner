{% extends "base.html" %}
{% import "partials/tree.html" as macros %}

{% block title %}Results{% endblock %}
{% block main %}
<div id="results">
  <aside class="box-shadow">
    <div id="tree">
    {{ macros.render_source_tree(root_path, source_tree, nodes_data, directory_content) }}
    </div>
  </aside>
  <article class="box-shadow">
    <hgroup>
      <h2 class="size-3">Results tree</h2>
      <p name="help" class="size-6">Click on a directory or a file for result details.</p>
    </hgroup>
    <div id="selected_path">
      <h3 name="rpath" class="size-4"></h3>
      <dl name="definition">
        <dt>Name</dt>
        <dd name="name">
          <a href="#" title="Copy path" name="name_link"></a>
        </dd>
        <dt>Type</dt>
        <dd name="type"></dd>
        <dt>Known</dt>
        <dd name="known"></dd>
        <dt>Swhid</dt>
        <dd name="swhid">
          <a href="" title="Search the Software Heritage Archive for this swhid" name="swhid_link" target="_blank"></a>
        </dd>
      </dl>
    </div>
  </article>
</div>
{% endblock main %}
{% block jsbottom %}
<script>
  async function copyToClipboard(text, elt) {
    if (navigator && navigator.clipboard && navigator.clipboard.writeText)
      try {
        await navigator.clipboard.writeText(text).then(function() {
          const tooltip_elt = document.createElement("span")
          tooltip_elt.classList.add("tooltip")
          tooltip_elt.textContent = "‚úî Copied!"
          elt.insertAdjacentElement("afterend", tooltip_elt)
          setTimeout(function() {
            tooltip_elt.remove()
          }, 1000);
        })
      } catch {
        alert("Copy failed: " + err)
      }
    else
      return Promise.reject("The Clipboard API is not available")
  }

  document.addEventListener("DOMContentLoaded", function() {
    const tree = document.getElementById("tree")
    const selected_path = document.getElementById("selected_path")
    selected_path.style.visibility = "hidden"

    if (!tree || !selected_path) {
      console.error("Can not find the results tree or selected path in the DOM")
      return
    }

    tree.addEventListener("click", function(event) {
      const tree_selected_path = event.target.closest("details")
      if (!tree_selected_path) return

      if (tree_selected_path.dataset.type === "directory") {
        // Progressive tree loading
        const subtree_path_url = "/api/v1/html-tree/" + tree_selected_path.dataset.rpath
        subtree_path_url.replace(/\/{2,}/g, '/') // ensure single slash
        const subtree_dest = tree_selected_path.getElementsByTagName("summary")[0]
        if (subtree_dest.nextElementSibling === null){
          fetch(subtree_path_url)
              .then(response => response.json())
              .then(data => {
                subtree_dest.insertAdjacentHTML("afterend", data["html"])
              })
        }
      }

      // Relative path as title with pie indicator
      const pie = tree_selected_path.firstElementChild.children.namedItem("pie").cloneNode(true)
      const rpath = selected_path.children.namedItem("rpath")
      rpath.textContent = tree_selected_path.dataset.rpath
      rpath.insertAdjacentElement("afterbegin", pie)

      // Definition list element
      const definition = selected_path.children.namedItem("definition")

      // Directory name with copy to clipboard link
      const name_link = definition.children.namedItem("name").children.namedItem("name_link")
      name_link.textContent = "üóê " + tree_selected_path.dataset.name
      name_link.onclick = function() {
        copyToClipboard(tree_selected_path.dataset.fpath, name_link)
        return false
      }

      // Known
      const known_icon = (tree_selected_path.dataset.known === "true") ? "‚úî" : "‚úò"
      const known = definition.children.namedItem("known")
      known.textContent = known_icon + " " + tree_selected_path.dataset.known

      // Swhid with search link to the archive
      const search_swhid = "https://archive.softwareheritage.org/" + tree_selected_path.dataset.swhid
      const swhid_link = definition.children.namedItem("swhid").children.namedItem("swhid_link")
      swhid_link.href = search_swhid
      swhid_link.textContent = tree_selected_path.dataset.swhid

      // Type
      definition.children.namedItem("type").textContent = (tree_selected_path.dataset.type === "directory") ? "üóÄ  " + tree_selected_path.dataset.type  : tree_selected_path.dataset.type

      // Display result
      if (selected_path.style.visibility == "hidden") selected_path.style.visibility = "visible"
    });
  });
</script>
{% endblock jsbottom %}
